<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbre G√©n√©alogique Dynamique - Ta'a Fieu Tagni Tinang Joseph</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c5f4f;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4a7c6b 0%, #2c5f4f 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .tabs-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #2c5f4f;
            background: #f0f8f5;
        }

        .tab.active {
            color: #2c5f4f;
            border-bottom-color: #4a7c6b;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tree-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .generation-row {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 60px;
            position: relative;
        }

        .generation-row::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: #ccc;
        }

        .generation-row:last-child::after {
            display: none;
        }

        .generation-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: bold;
            color: #2c5f4f;
            margin-right: 20px;
            padding: 10px;
            background: #e8f4f0;
            border-radius: 8px;
        }

        .members-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            flex: 1;
        }

        .person-box {
            padding: 15px 20px;
            border-radius: 8px;
            min-width: 180px;
            max-width: 220px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
            position: relative;
        }

        .person-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .person-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .person-dates {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .person-role {
            font-size: 0.85em;
            margin-top: 5px;
            font-style: italic;
        }

        /* √âditeur */
        .editor-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c5f4f;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a7c6b;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4a7c6b;
            color: white;
        }

        .btn-primary:hover {
            background: #2c5f4f;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-export {
            background: #17a2b8;
            color: white;
            margin-left: 10px;
        }

        .btn-export:hover {
            background: #138496;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }

        .modal-close:hover {
            color: #000;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .person-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .person-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4a7c6b;
            cursor: pointer;
            transition: all 0.3s;
        }

        .person-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .person-item h4 {
            color: #2c5f4f;
            margin-bottom: 5px;
        }

        .person-item p {
            font-size: 0.9em;
            color: #666;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .generation-label {
                writing-mode: horizontal-tb;
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå≥ Arbre G√©n√©alogique Dynamique</h1>
        <p><strong>Ta'a Fieu Tagni Tinang Joseph</strong></p>
        <p style="font-size: 0.9em; color: #888; margin-top: 10px;">Syst√®me automatique ‚Ä¢ G√©n√©ration calcul√©e dynamiquement</p>
    </div>

    <div class="stats-container" id="statsContainer">
        <!-- Stats will be generated dynamically -->
    </div>

    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('tree', this)">üå≥ Arbre</button>
            <button class="tab" onclick="switchTab('editor', this)">‚úèÔ∏è √âditeur</button>
            <button class="tab" onclick="switchTab('list', this)">üë• Liste</button>
        </div>

        <!-- Tree Tab -->
        <div id="tree" class="tab-content active">
            <h2 style="color: #2c5f4f; margin-bottom: 20px;">Arbre g√©n√©alogique (g√©n√©rations automatiques)</h2>
            <div id="familyTree" class="tree-container">
                <p style="text-align: center; color: #666;">Chargement des donn√©es...</p>
            </div>
        </div>

        <!-- Editor Tab -->
        <div id="editor" class="tab-content">
            <h2 style="color: #2c5f4f; margin-bottom: 20px;">Ajouter/Modifier une personne</h2>
            <div class="editor-container">
                <div class="success-message" id="successMessage">
                    Personne ajout√©e avec succ√®s ! L'arbre a √©t√© mis √† jour.
                </div>

                <form id="personForm" onsubmit="addPerson(event)">
                    <div class="form-group">
                        <label for="personId">ID unique* (ex: serge_poueme_2025)</label>
                        <input type="text" id="personId" required placeholder="Identifiant unique sans espaces">
                    </div>

                    <div class="form-group">
                        <label for="personName">Nom complet*</label>
                        <input type="text" id="personName" required placeholder="Pr√©nom Nom">
                    </div>

                    <div class="form-group">
                        <label for="personDates">Dates (optionnel)</label>
                        <input type="text" id="personDates" placeholder="1983 ou 1950-2020">
                    </div>

                    <div class="form-group">
                        <label for="personBorn">Ann√©e de naissance (optionnel)</label>
                        <input type="text" id="personBorn" placeholder="1983">
                    </div>

                    <div class="form-group">
                        <label for="personBirthPlace">Lieu de naissance</label>
                        <input type="text" id="personBirthPlace" placeholder="Yaound√©, Cameroun">
                    </div>

                    <div class="form-group">
                        <label for="personResidence">R√©sidence actuelle</label>
                        <input type="text" id="personResidence" placeholder="Canada (Qu√©bec)">
                    </div>

                    <div class="form-group">
                        <label for="personParent">Parent (s√©lectionner dans la liste)</label>
                        <select id="personParent">
                            <option value="">-- Aucun parent (g√©n√©ration 1) --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="personRole">R√¥le (optionnel)</label>
                        <input type="text" id="personRole" placeholder="H√©ritier, Patriarche, etc.">
                    </div>

                    <div class="form-group">
                        <label for="personNotes">Notes</label>
                        <textarea id="personNotes" placeholder="Informations additionnelles sur la personne"></textarea>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">üíæ Ajouter la personne</button>
                        <button type="button" class="btn btn-export" onclick="exportJSON()">üì• Exporter JSON</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- List Tab -->
        <div id="list" class="tab-content">
            <h2 style="color: #2c5f4f; margin-bottom: 20px;">Toutes les personnes</h2>
            <div id="personsList" class="person-list">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal for person details -->
    <div class="modal" id="personModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        let familyData = { persons: [], locations: [] };
        let generationsMap = new Map();

        // Load data from JSON
        async function loadData() {
            try {
                const response = await fetch('family-data-dynamic.json');
                if (!response.ok) {
                    throw new Error('Fichier JSON introuvable');
                }
                familyData = await response.json();
                console.log('Donn√©es charg√©es:', familyData.persons.length, 'personnes');
                
                calculateGenerations();
                renderStats();
                renderTree();
                populateParentSelect();
                renderPersonsList();
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('familyTree').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>‚ùå Erreur de chargement</h3>
                        <p>Assurez-vous que le fichier <strong>family-data-dynamic.json</strong> est pr√©sent.</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Erreur: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Calculate generations automatically from parent relationships
        function calculateGenerations() {
            generationsMap.clear();
            
            // Find root persons (no parent)
            const roots = familyData.persons.filter(p => !p.parentId);
            
            // Assign generation 1 to roots
            roots.forEach(person => {
                generationsMap.set(person.id, 1);
            });

            // Recursively assign generations
            let maxIterations = 20;
            let iteration = 0;
            let changed = true;

            while (changed && iteration < maxIterations) {
                changed = false;
                iteration++;

                familyData.persons.forEach(person => {
                    if (!generationsMap.has(person.id) && person.parentId) {
                        const parentGen = generationsMap.get(person.parentId);
                        if (parentGen !== undefined) {
                            generationsMap.set(person.id, parentGen + 1);
                            changed = true;
                        }
                    }
                });
            }

            console.log('G√©n√©rations calcul√©es:', generationsMap.size, 'personnes assign√©es');
        }

        // Get generation number for a person
        function getGeneration(personId) {
            return generationsMap.get(personId) || 1;
        }

        // Get color for generation
        function getGenerationColor(genNum) {
            const colors = [
                { bg: 'linear-gradient(135deg, #a8d5ba 0%, #88c0a5 100%)', border: '#6fa585' },
                { bg: 'linear-gradient(135deg, #d4d4d4 0%, #b8b8b8 100%)', border: '#999' },
                { bg: 'linear-gradient(135deg, #333333 0%, #1a1a1a 100%)', border: '#000', color: 'white' },
                { bg: 'linear-gradient(135deg, #f4e04d 0%, #e8d73a 100%)', border: '#d4c230' },
                { bg: 'linear-gradient(135deg, #a8d5ba 0%, #88c0a5 100%)', border: '#6fa585' },
                { bg: 'linear-gradient(135deg, #87ceeb 0%, #6db9d6 100%)', border: '#5a9fc0' },
                { bg: 'linear-gradient(135deg, #4682b4 0%, #36648b 100%)', border: '#2c5474', color: 'white' }
            ];
            
            const index = (genNum - 1) % colors.length;
            return colors[index];
        }

        // Render statistics
        function renderStats() {
            const totalPersons = familyData.persons.length;
            const maxGen = Math.max(...Array.from(generationsMap.values()));
            const locations = familyData.locations.length;

            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalPersons}</div>
                    <div class="stat-label">Membres de la famille</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${maxGen}</div>
                    <div class="stat-label">G√©n√©rations (auto)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${locations}</div>
                    <div class="stat-label">Localit√©s</div>
                </div>
            `;
        }

        // Render family tree
        function renderTree() {
            const maxGen = Math.max(...Array.from(generationsMap.values()));
            const treeContainer = document.getElementById('familyTree');
            
            let html = '';

            for (let gen = 1; gen <= maxGen; gen++) {
                const personsInGen = familyData.persons.filter(p => getGeneration(p.id) === gen);
                
                if (personsInGen.length === 0) continue;

                html += `
                    <div class="generation-row">
                        <div class="generation-label">
                            G√©n√©ration ${gen}
                            <br><span style="font-size: 0.8em;">(${personsInGen.length} membre${personsInGen.length > 1 ? 's' : ''})</span>
                        </div>
                        <div class="members-container">
                `;

                personsInGen.forEach(person => {
                    html += createPersonBox(person, gen);
                });

                html += `
                        </div>
                    </div>
                `;
            }

            treeContainer.innerHTML = html;
        }

        // Create person box
        function createPersonBox(person, genNum) {
            const color = getGenerationColor(genNum);
            const dates = person.dates || (person.born ? `n√© ${person.born}` : '');
            const role = person.role ? `<div class="person-role">${person.role}</div>` : '';
            
            const styleAttr = `background: ${color.bg}; border-color: ${color.border}; ${color.color ? `color: ${color.color};` : ''}`;

            return `
                <div class="person-box" style="${styleAttr}" onclick="showPersonDetails('${person.id}')">
                    <div class="person-name">${person.name}</div>
                    ${dates ? `<div class="person-dates">${dates}</div>` : ''}
                    ${role}
                </div>
            `;
        }

        // Show person details in modal
        function showPersonDetails(personId) {
            const person = familyData.persons.find(p => p.id === personId);
            if (!person) return;

            const parent = person.parentId ? familyData.persons.find(p => p.id === person.parentId) : null;
            const children = familyData.persons.filter(p => p.parentId === person.id);
            const generation = getGeneration(person.id);

            let html = `
                <div style="margin-bottom: 20px;">
                    <h2 style="color: #2c5f4f;">${person.name}</h2>
                    ${person.ndap ? `<p style="font-style: italic; color: #666;">Ndap: ${person.ndap}</p>` : ''}
                    ${person.dates || person.born ? `<p><strong>üìÖ Dates:</strong> ${person.dates || 'N√© ' + person.born}</p>` : ''}
                    <p><strong>üß¨ G√©n√©ration:</strong> ${generation}</p>
                </div>

                ${person.birthPlace ? `<p><strong>üìç Lieu de naissance:</strong> ${person.birthPlace}</p>` : ''}
                ${person.residence ? `<p><strong>üè† R√©sidence:</strong> ${person.residence}</p>` : ''}
                ${person.role ? `<p><strong>üëë R√¥le:</strong> ${person.role}</p>` : ''}
                ${person.occupation ? `<p><strong>üíº Profession:</strong> ${person.occupation}</p>` : ''}
                
                ${parent ? `<p style="margin-top: 15px;"><strong>‚¨ÜÔ∏è Parent:</strong> ${parent.name}</p>` : ''}
                
                ${children.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <strong>‚¨áÔ∏è Enfants (${children.length}):</strong>
                        <ul style="margin-left: 20px; margin-top: 8px;">
                            ${children.map(c => `<li>${c.name}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${person.notes ? `<p style="margin-top: 15px;"><strong>üìù Notes:</strong> ${person.notes}</p>` : ''}
            `;

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('personModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('personModal').classList.remove('active');
        }

        // Tab switching
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            if (element) element.classList.add('active');
        }

        // Populate parent select dropdown
        function populateParentSelect() {
            const select = document.getElementById('personParent');
            select.innerHTML = '<option value="">-- Aucun parent (g√©n√©ration 1) --</option>';
            
            familyData.persons
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = `${person.name} (G√©n ${getGeneration(person.id)})`;
                    select.appendChild(option);
                });
        }

        // Add new person
        function addPerson(event) {
            event.preventDefault();

            const newPerson = {
                id: document.getElementById('personId').value.trim(),
                name: document.getElementById('personName').value.trim(),
                dates: document.getElementById('personDates').value.trim() || undefined,
                born: document.getElementById('personBorn').value.trim() || undefined,
                birthPlace: document.getElementById('personBirthPlace').value.trim() || undefined,
                residence: document.getElementById('personResidence').value.trim() || undefined,
                parentId: document.getElementById('personParent').value || null,
                role: document.getElementById('personRole').value.trim() || undefined,
                notes: document.getElementById('personNotes').value.trim() || undefined,
                spouseIds: []
            };

            // Check if ID already exists
            if (familyData.persons.find(p => p.id === newPerson.id)) {
                alert('‚ùå Cet ID existe d√©j√†. Veuillez en choisir un autre.');
                return;
            }

            // Add person
            familyData.persons.push(newPerson);
            
            // Recalculate and re-render
            calculateGenerations();
            renderStats();
            renderTree();
            populateParentSelect();
            renderPersonsList();

            // Show success message
            document.getElementById('successMessage').classList.add('show');
            setTimeout(() => {
                document.getElementById('successMessage').classList.remove('show');
            }, 3000);

            // Reset form
            document.getElementById('personForm').reset();
        }

        // Reset form
        function resetForm() {
            document.getElementById('personForm').reset();
        }

        // Export JSON
        function exportJSON() {
            const dataStr = JSON.stringify(familyData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'family-data-dynamic-updated.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Render persons list
        function renderPersonsList() {
            const container = document.getElementById('personsList');
            let html = '';

            // Sort by generation then by name
            const sortedPersons = [...familyData.persons].sort((a, b) => {
                const genDiff = getGeneration(a.id) - getGeneration(b.id);
                if (genDiff !== 0) return genDiff;
                return a.name.localeCompare(b.name);
            });

            sortedPersons.forEach(person => {
                html += `
                    <div class="person-item" onclick="showPersonDetails('${person.id}')">
                        <h4>${person.name}</h4>
                        <p>G√©n√©ration ${getGeneration(person.id)}</p>
                        ${person.residence ? `<p>üìç ${person.residence}</p>` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', loadData);

        // Close modal on outside click
        document.getElementById('personModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
