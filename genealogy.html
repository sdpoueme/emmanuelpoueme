<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbre G√©n√©alogique - Ta'a Fieu Tagni Tinang Joseph</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 { color: #2c5f4f; font-size: 2.5em; margin-bottom: 10px; }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #4a7c6b 0%, #2c5f4f 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { font-size: 2.5em; font-weight: bold; }
        .stat-label { font-size: 1em; opacity: 0.9; margin-top: 5px; }
        .tabs-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab:hover { color: #2c5f4f; background: #f0f8f5; }
        .tab.active { color: #2c5f4f; border-bottom-color: #4a7c6b; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Tree specific */
        .tree-search {
            margin-bottom: 20px;
        }
        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: #4a7c6b;
            box-shadow: 0 0 10px rgba(74, 124, 107, 0.2);
        }
        
        /* Generation Filters */
        .generation-filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .filter-title {
            color: #2c5f4f;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        .gen-filter {
            padding: 8px 16px;
            border: 2px solid #4a7c6b;
            background: white;
            color: #4a7c6b;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .gen-filter.active {
            background: #4a7c6b;
            color: white;
        }
        .gen-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .filter-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        .all-filters {
            padding: 8px 16px;
            border: 2px solid #666;
            background: white;
            color: #666;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
        }
        .all-filters.active {
            background: #666;
            color: white;
        }
        
        .tree-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .generation-row {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 60px;
            position: relative;
        }
        .generation-row.hidden { display: none; }
        .generation-row::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: #ccc;
        }
        .generation-row:last-child::after { display: none; }
        .generation-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: bold;
            color: #2c5f4f;
            margin-right: 20px;
            padding: 10px;
            background: #e8f4f0;
            border-radius: 8px;
        }
        .members-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            flex: 1;
        }
        .person-box {
            padding: 15px 20px;
            border-radius: 8px;
            min-width: 180px;
            max-width: 220px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
            position: relative;
        }
        
        /* Lign√©e fusionn√©e - Bordure double distinctive */
        .person-box.merged-lineage {
            border: 3px double #ffc107 !important;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
        }
        .person-box.merged-lineage::before {
            content: "üîó";
            position: absolute;
            top: -12px;
            right: -12px;
            background: #ffc107;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .person-box:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .person-box.highlighted {
            border-color: #ff6b6b !important;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.5) !important;
        }
        .person-name { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .person-dates { font-size: 0.9em; opacity: 0.8; }
        .person-role { font-size: 0.85em; margin-top: 5px; font-style: italic; }
        
        /* Conteneur pour les lignes SVG de connexion */
        .generation-row {
            position: relative;
        }
        .marriage-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .members-container {
            position: relative;
            z-index: 2;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }
        .modal-close:hover { color: #000; }
        
        /* Persons list */
        .person-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .person-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4a7c6b;
            cursor: pointer;
            transition: all 0.3s;
        }
        .person-item:hover { background: #e9ecef; transform: translateX(5px); }
        .person-item h4 { color: #2c5f4f; margin-bottom: 5px; }
        .person-item p { font-size: 0.9em; color: #666; }
        
        /* Locations */
        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .location-card {
            background: linear-gradient(135deg, #f0f8f5 0%, #e8f4f0 100%);
            border-left: 5px solid #4a7c6b;
            border-radius: 10px;
            padding: 20px;
        }
        .location-card h3 { color: #2c5f4f; margin-bottom: 10px; }
        
        /* Timeline */
        .timeline { position: relative; padding: 20px 0; }
        .timeline-item { display: flex; margin-bottom: 30px; position: relative; }
        .timeline-date {
            min-width: 120px;
            font-weight: bold;
            color: #4a7c6b;
            padding-right: 20px;
        }
        .timeline-content {
            flex: 1;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #4a7c6b;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .timeline-content h4 { color: #2c5f4f; margin-bottom: 8px; }
        .timeline-content p { color: #666; line-height: 1.6; }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .generation-label { writing-mode: horizontal-tb; margin-right: 0; margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå≥ Arbre G√©n√©alogique</h1>
        <p><strong>Ta'a Fieu Tagni Tinang Joseph</strong></p>
        <p style="font-size: 0.9em; color: #888; margin-top: 10px;">Syst√®me dynamique ‚Ä¢ G√©n√©rations calcul√©es automatiquement</p>
    </div>

    <div class="stats-container" id="statsContainer"></div>

    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview', this)">üìä Aper√ßu</button>
            <button class="tab" onclick="switchTab('royal', this)">üëë Lign√©es Royales</button>
            <button class="tab" onclick="switchTab('tree', this)">üå≥ Arbre</button>
            <button class="tab" onclick="switchTab('persons', this)">üë• Personnes</button>
            <button class="tab" onclick="switchTab('locations', this)">üìç Localit√©s</button>
            <button class="tab" onclick="switchTab('timeline', this)">üìÖ Dates Cl√©s</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <h2 style="color: #2c5f4f; margin-bottom: 20px;">Vue d'ensemble de la famille</h2>
            <div id="overviewContent">
                <!-- Will be generated -->
            </div>
        </div>

        <!-- Royal Lineages Tab -->
        <div id="royal" class="tab-content">
            <h2 style="color: #2c5f4f; margin-bottom: 20px;">üëë Lign√©es Royales</h2>
            <div style="background: linear-gradient(135deg, #fff8e1 0%, #ffe082 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; border: 3px solid #ffd54f;">
                <h3 style="color: #2c5f4f; margin-bottom: 15px; text-align: center;">Statut Royal</h3>
                <p style="text-align: center; font-size: 1.1em; line-height: 1.8;">
                    En tant que descendants des chefferies <strong>Baleng</strong>, <strong>Balengou</strong>, <strong>Batchingou</strong> et <strong>Bamena</strong>, 
                    les petits-fils et arri√®re-petits-fils de Magni Kouabou et de Tchi√© Ngantchi√© sont des <strong style="color: #d4a300;">princes et altesses royales</strong>.
                </p>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                <div style="background: white; padding: 25px; border-radius: 12px; border-left: 6px solid #8b4513; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #2c5f4f; margin-bottom: 15px;">1Ô∏è‚É£ CHEFFERIE BALENG</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin: 10px 0;">üë§ <strong>Connexion:</strong> Prince Nandjo (~1770s)</li>
                        <li style="margin: 10px 0;">üö∂ <strong>Migration:</strong> Baleng ‚Üí Balengou</li>
                    </ul>
                </div>
                <div style="background: white; padding: 25px; border-radius: 12px; border-left: 6px solid #4a7c6b; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #2c5f4f; margin-bottom: 15px;">2Ô∏è‚É£ CHEFFERIE BALENGOU</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin: 10px 0;">üë§ <strong>Connexion:</strong> Wetio Kouamou</li>
                        <li style="margin: 10px 0;">üéñÔ∏è <strong>Titre:</strong> "Ta'a fieu"</li>
                    </ul>
                </div>
                <div style="background: white; padding: 25px; border-radius: 12px; border-left: 6px solid #2196f3; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #2c5f4f; margin-bottom: 15px;">3Ô∏è‚É£ CHEFFERIE BATCHINGOU</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin: 10px 0;">üë§ <strong>Connexion:</strong> Tchi√© Ngantchi√©</li>
                        <li style="margin: 10px 0;">‚öîÔ∏è <strong>Fonction:</strong> Ministre D√©fense</li>
                    </ul>
                </div>
                <div style="background: white; padding: 25px; border-radius: 12px; border-left: 6px solid #9c27b0; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #2c5f4f; margin-bottom: 15px;">4Ô∏è‚É£ CHEFFERIE BAMENA</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin: 10px 0;">üë§ <strong>Connexion:</strong> Ta'a Nanwou</li>
                        <li style="margin: 10px 0;">üëë <strong>Lign√©e:</strong> Megni Ngongang Rebecca</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Tree Tab -->
        <div id="tree" class="tab-content">
            <h2 style="color: #2c5f4f; margin-bottom: 20px;">Arbre (g√©n√©rations automatiques)</h2>
            
            <!-- Search Bar -->
            <div class="tree-search">
                <input type="text" class="search-input" id="treeSearch" placeholder="üîç Rechercher une personne dans l'arbre..." onkeyup="searchInTree()">
            </div>
            
            <!-- Generation Filters -->
            <div class="generation-filters">
                <div class="filter-title">
                    üîç Filtrer par g√©n√©ration
                    <span id="visibleCount" style="color: #666; font-size: 0.9em;"></span>
                </div>
                <div class="filter-buttons" id="filterButtons">
                    <!-- Will be generated by JavaScript -->
                </div>
            </div>
            
            <div id="familyTree" class="tree-container">
                <p style="text-align: center; color: #666;">Chargement...</p>
            </div>
        </div>

        <!-- Persons Tab -->
        <div id="persons" class="tab-content">
            <h2 style="color: #2c5f4f; margin-bottom: 20px;">Tous les membres</h2>
            
            <!-- Search for persons -->
            <div class="tree-search">
                <input type="text" class="search-input" id="personSearch" placeholder="üîç Rechercher par nom..." onkeyup="filterPersons()">
            </div>
            
            <div id="personsList" class="person-list"></div>
        </div>

        <!-- Locations Tab -->
        <div id="locations" class="tab-content">
            <h2 style="color: #2c5f4f; margin-bottom: 20px;">Localit√©s familiales</h2>
            <div id="locationsGrid" class="locations-grid"></div>
        </div>

        <!-- Timeline Tab -->
        <div id="timeline" class="tab-content">
            <h2 style="color: #2c5f4f; margin-bottom: 20px;">Chronologie</h2>
            <div id="timelineContent" class="timeline"></div>
        </div>
    </div>

    <div class="modal" id="personModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        let familyData = { persons: [], locations: [] };
        let generationsMap = new Map();
        let visibleGenerations = new Set();
        let showSpousesAsSeparateBoxes = false; // Toggle pour afficher les conjoints s√©par√©ment

        async function loadData() {
            try {
                const response = await fetch('family-data-dynamic.json');
                familyData = await response.json();
                calculateGenerations();
                
                // Initialize all generations as visible
                const maxGen = Math.max(...Array.from(generationsMap.values()));
                for (let i = 1; i <= maxGen; i++) {
                    visibleGenerations.add(i);
                }
                
                renderStats();
                renderOverview();
                renderTree();
                renderGenerationFilters();
                renderPersonsList();
                renderLocations();
                renderTimeline();
                updateVisibleCount();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function calculateGenerations() {
            generationsMap.clear();
            
            // Step 1: Assign generation 1 to roots (no parentId and no spouseIds)
            const trueRoots = familyData.persons.filter(p => !p.parentId && (!p.spouseIds || p.spouseIds.length === 0));
            trueRoots.forEach(p => generationsMap.set(p.id, 1));
            
            // Step 2: Calculate generations based on parent-child relationships
            let changed = true, iter = 0;
            while (changed && iter++ < 20) {
                changed = false;
                familyData.persons.forEach(p => {
                    if (!generationsMap.has(p.id) && p.parentId) {
                        const parentGen = generationsMap.get(p.parentId);
                        if (parentGen !== undefined) {
                            generationsMap.set(p.id, parentGen + 1);
                            changed = true;
                        }
                    }
                });
            }
            
            // Step 3: For people who marry into the family (have BOTH parentId AND spouseIds)
            // Use spouse's generation for DISPLAY if it's higher (merged lineages)
            iter = 0;
            changed = true;
            while (changed && iter++ < 20) {
                changed = false;
                familyData.persons.forEach(p => {
                    if (p.parentId && p.spouseIds && p.spouseIds.length > 0) {
                        const currentGen = generationsMap.get(p.id);
                        // Find spouse with highest generation
                        for (const spouseId of p.spouseIds) {
                            const spouseGen = generationsMap.get(spouseId);
                            if (spouseGen !== undefined && spouseGen > currentGen) {
                                generationsMap.set(p.id, spouseGen);
                                changed = true;
                                break;
                            }
                        }
                    }
                });
            }
            
            // Step 4: Assign remaining spouses to same generation as their partner
            iter = 0;
            changed = true;
            while (changed && iter++ < 20) {
                changed = false;
                familyData.persons.forEach(p => {
                    if (!generationsMap.has(p.id) && p.spouseIds && p.spouseIds.length > 0) {
                        for (const spouseId of p.spouseIds) {
                            const spouseGen = generationsMap.get(spouseId);
                            if (spouseGen !== undefined) {
                                generationsMap.set(p.id, spouseGen);
                                changed = true;
                                break;
                            }
                        }
                    }
                });
            }
        }

        function getGeneration(id) { return generationsMap.get(id) || 1; }

        function getGenerationColor(n) {
            const c = [
                { bg: 'linear-gradient(135deg, #a8d5ba 0%, #88c0a5 100%)', border: '#6fa585' },
                { bg: 'linear-gradient(135deg, #d4d4d4 0%, #b8b8b8 100%)', border: '#999' },
                { bg: 'linear-gradient(135deg, #333 0%, #1a1a1a 100%)', border: '#000', color: 'white' },
                { bg: 'linear-gradient(135deg, #f4e04d 0%, #e8d73a 100%)', border: '#d4c230' },
                { bg: 'linear-gradient(135deg, #a8d5ba 0%, #88c0a5 100%)', border: '#6fa585' },
                { bg: 'linear-gradient(135deg, #87ceeb 0%, #6db9d6 100%)', border: '#5a9fc0' },
                { bg: 'linear-gradient(135deg, #4682b4 0%, #36648b 100%)', border: '#2c5474', color: 'white' }
            ];
            return c[(n - 1) % c.length];
        }

        function renderStats() {
            const maxGen = Math.max(...Array.from(generationsMap.values()));
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card"><div class="stat-number">${familyData.persons.length}</div><div class="stat-label">Membres</div></div>
                <div class="stat-card"><div class="stat-number">${maxGen}</div><div class="stat-label">G√©n√©rations (auto)</div></div>
                <div class="stat-card"><div class="stat-number">${familyData.locations.length}</div><div class="stat-label">Localit√©s</div></div>
                <div class="stat-card"><div class="stat-number">255</div><div class="stat-label">Ans d'histoire</div></div>
            `;
        }

        function renderOverview() {
            const p = familyData.persons.find(x => x.role === 'Patriarche');
            const h = familyData.persons.find(x => x.role === 'H√©ritier');
            
            document.getElementById('overviewContent').innerHTML = `
                <div style="background: linear-gradient(135deg, #f0f8f5 0%, #e8f4f0 100%); padding: 30px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #2c5f4f; margin-bottom: 15px;">üëë Le Patriarche</h3>
                    <h4 style="color: #4a7c6b;">${p.name}</h4>
                    <p><strong>${p.dates}</strong> (${p.lifespan})</p>
                    <p style="margin-top: 10px;">${p.birthPlace}</p>
                    <p style="margin-top: 10px;"><em>${p.notes}</em></p>
                </div>

                <div style="background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%); padding: 30px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #2c5f4f; margin-bottom: 15px;">‚≠ê L'H√©ritier</h3>
                    <h4 style="color: #4a7c6b;">${h.name}</h4>
                    <p><strong>Ndap:</strong> ${h.ndap}</p>
                    <p><strong>N√©:</strong> ${h.born}</p>
                    <p style="margin-top: 10px;">${h.notes}</p>
                </div>

                <div style="background: linear-gradient(135deg, #fef9e7 0%, #fcf3cf 100%); padding: 30px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #f4d03f;">
                    <h3 style="color: #2c5f4f; margin-bottom: 20px; text-align: center;">üëë Lign√©es Royales</h3>
                    <p style="text-align: center; margin-bottom: 20px; font-style: italic; color: #666;">
                        La famille descend de quatre chefferies royales Bamil√©k√©
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 5px solid #e67e22;">
                            <h4 style="color: #e67e22; margin-bottom: 12px;">1Ô∏è‚É£ BALENG</h4>
                            <p style="color: #555; line-height: 1.6;"><strong>üìç Prince Nandjo</strong> (~1770s) - Fondateur</p>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 5px solid #27ae60;">
                            <h4 style="color: #27ae60; margin-bottom: 12px;">2Ô∏è‚É£ BALENGOU</h4>
                            <p style="color: #555; line-height: 1.6;"><strong>üëë Wetio Kouamou</strong> - Titre "Ta'a fieu"</p>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 5px solid #c0392b;">
                            <h4 style="color: #c0392b; margin-bottom: 12px;">3Ô∏è‚É£ BATCHINGOU</h4>
                            <p style="color: #555; line-height: 1.6;"><strong>‚öîÔ∏è Tchi√© Ngantchi√©</strong> - Ministre D√©fense</p>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 5px solid #8e44ad;">
                            <h4 style="color: #8e44ad; margin-bottom: 12px;">4Ô∏è‚É£ BAMENA</h4>
                            <p style="color: #555; line-height: 1.6;"><strong>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ta'a Nanwou</strong> - Patriarche de Bamena</p>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #d4af37;">
                        <h4 style="color: #8b4513; margin-bottom: 10px;">üìä Histoire</h4>
                        <p><strong>255 ans</strong></p>
                        <p style="font-size: 0.9em; color: #666;">~1770s - 2025</p>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #4a7c6b;">
                        <h4 style="color: #2c5f4f; margin-bottom: 10px;">üìä Le Patriarche</h4>
                        <p><strong>9 enfants</strong></p>
                        <p style="font-size: 0.9em; color: #666;">3 √©pouses</p>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #4a7c6b;">
                        <h4 style="color: #2c5f4f; margin-bottom: 10px;">üìä G√©n√©ration 7</h4>
                        <p><strong>18 petits-enfants</strong></p>
                        <p style="font-size: 0.9em; color: #666;">Dispers√©s mondialement</p>
                    </div>
                </div>
            `;
        }

        function renderGenerationFilters() {
            const maxGen = Math.max(...Array.from(generationsMap.values()));
            let html = '<button class="all-filters active" onclick="toggleAllGenerations()">Toutes</button>';
            
            for (let g = 1; g <= maxGen; g++) {
                const count = familyData.persons.filter(p => getGeneration(p.id) === g).length;
                html += `
                    <button class="gen-filter active" data-gen="${g}" onclick="toggleGeneration(${g})">
                        G√©n ${g} <span class="filter-count" id="count-${g}">${count}</span>
                    </button>
                `;
            }
            
            // Ajouter le toggle pour les conjoints
            html += `
                <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9em; color: #666;">
                        <input type="checkbox" id="spousesToggle" onchange="toggleSpousesDisplay()" 
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span>Afficher conjoints s√©par√©ment + lignes</span>
                    </label>
                </div>
            `;
            
            document.getElementById('filterButtons').innerHTML = html;
        }

        function toggleGeneration(genNum) {
            const button = document.querySelector(`[data-gen="${genNum}"]`);
            const rows = document.querySelectorAll(`[data-generation="${genNum}"]`);
            
            if (visibleGenerations.has(genNum)) {
                visibleGenerations.delete(genNum);
                button.classList.remove('active');
                rows.forEach(row => row.classList.add('hidden'));
            } else {
                visibleGenerations.add(genNum);
                button.classList.add('active');
                rows.forEach(row => row.classList.remove('hidden'));
            }
            
            updateAllButton();
            updateVisibleCount();
            setTimeout(drawMarriageLines, 50);
        }

        function toggleAllGenerations() {
            const maxGen = Math.max(...Array.from(generationsMap.values()));
            const allButton = document.querySelector('.all-filters');
            const isAllVisible = visibleGenerations.size === maxGen;
            
            if (isAllVisible) {
                visibleGenerations.clear();
                document.querySelectorAll('.gen-filter').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.generation-row').forEach(row => row.classList.add('hidden'));
                allButton.classList.remove('active');
            } else {
                for (let i = 1; i <= maxGen; i++) visibleGenerations.add(i);
                document.querySelectorAll('.gen-filter').forEach(btn => btn.classList.add('active'));
                document.querySelectorAll('.generation-row').forEach(row => row.classList.remove('hidden'));
                allButton.classList.add('active');
            }
            
            updateVisibleCount();
            setTimeout(drawMarriageLines, 50);
        }

        function updateAllButton() {
            const maxGen = Math.max(...Array.from(generationsMap.values()));
            const allButton = document.querySelector('.all-filters');
            if (visibleGenerations.size === maxGen) {
                allButton.classList.add('active');
            } else {
                allButton.classList.remove('active');
            }
        }

        function updateVisibleCount() {
            const totalVisible = Array.from(visibleGenerations).reduce((sum, gen) => {
                const count = familyData.persons.filter(p => getGeneration(p.id) === gen).length;
                return sum + count;
            }, 0);
            document.getElementById('visibleCount').textContent = `(${totalVisible} membres visibles)`;
        }
        
        function toggleSpousesDisplay() {
            showSpousesAsSeparateBoxes = document.getElementById('spousesToggle').checked;
            renderTree(); // Re-rendre l'arbre avec ou sans conjoints s√©par√©s
        }

        function searchInTree() {
            const searchTerm = document.getElementById('treeSearch').value.toLowerCase();
            const personBoxes = document.querySelectorAll('.person-box');
            
            personBoxes.forEach(box => {
                const name = box.getAttribute('data-name');
                if (searchTerm === '' || name.includes(searchTerm)) {
                    box.classList.remove('highlighted');
                    if (searchTerm !== '' && name.includes(searchTerm)) {
                        box.classList.add('highlighted');
                    }
                } else {
                    box.classList.remove('highlighted');
                }
            });
        }

        function renderTree() {
            const maxGen = Math.max(...Array.from(generationsMap.values()));
            let html = '';
            for (let g = 1; g <= maxGen; g++) {
                let ps;
                
                if (showSpousesAsSeparateBoxes) {
                    // Mode √âTENDU : Afficher toutes les personnes, y compris les conjoints
                    ps = familyData.persons.filter(p => getGeneration(p.id) === g);
                } else {
                    // Mode COMPACT : Ne pas afficher les conjoints comme bo√Ætes s√©par√©es
                    // (ils sont d√©j√† mentionn√©s dans la bo√Æte de leur √©poux/√©pouse)
                    ps = familyData.persons.filter(p => {
                        if (getGeneration(p.id) !== g) return false;
                        // Afficher si : a un parent OU n'a pas de conjoint OU est une racine
                        return p.parentId || !p.spouseIds || p.spouseIds.length === 0 || (!p.parentId && g === 1);
                    });
                }
                
                if (ps.length === 0) continue;
                html += `<div class="generation-row" data-generation="${g}">
                    <div class="generation-label">G√©n√©ration ${g}<br><span style="font-size:0.8em;">(${ps.length})</span></div>
                    <div class="members-container">`;
                ps.forEach(p => html += createPersonBox(p, g));
                html += `</div></div>`;
            }
            document.getElementById('familyTree').innerHTML = html;
            
            // Dessiner les lignes de connexion entre √©poux (seulement si le toggle est activ√©)
            if (showSpousesAsSeparateBoxes) {
                setTimeout(drawMarriageLines, 100);
            }
        }
        
        function drawMarriageLines() {
            console.log('Drawing marriage lines...');
            
            // Parcourir toutes les g√©n√©rations visibles
            document.querySelectorAll('.generation-row:not(.hidden)').forEach(genRow => {
                // Supprimer les anciennes lignes SVG s'il y en a
                const oldSvg = genRow.querySelector('.marriage-lines');
                if (oldSvg) oldSvg.remove();
                
                // Cr√©er un SVG pour cette g√©n√©ration
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'marriage-lines');
                svg.style.position = 'absolute';
                svg.style.top = '0';
                svg.style.left = '0';
                svg.style.width = '100%';
                svg.style.height = '100%';
                svg.style.pointerEvents = 'none';
                svg.style.zIndex = '1';
                
                // Trouver toutes les bo√Ætes dans cette g√©n√©ration
                const boxes = genRow.querySelectorAll('.person-box');
                const boxesArray = Array.from(boxes);
                
                console.log(`Generation has ${boxesArray.length} boxes`);
                
                // Garder trace des paires d√©j√† dessin√©es pour √©viter les doublons
                const drawnPairs = new Set();
                
                // Pour chaque bo√Æte, v√©rifier si elle a un conjoint dans la m√™me g√©n√©ration
                boxesArray.forEach(box1 => {
                    const person1Id = box1.getAttribute('data-id');
                    const person1 = familyData.persons.find(p => p.id === person1Id);
                    
                    if (person1 && person1.spouseIds && person1.spouseIds.length > 0) {
                        console.log(`${person1.name} has ${person1.spouseIds.length} spouse(s)`);
                        
                        person1.spouseIds.forEach(spouseId => {
                            // V√©rifier si on n'a pas d√©j√† dessin√© cette paire
                            const pairKey1 = `${person1Id}-${spouseId}`;
                            const pairKey2 = `${spouseId}-${person1Id}`;
                            
                            if (drawnPairs.has(pairKey1) || drawnPairs.has(pairKey2)) {
                                return; // D√©j√† dessin√©
                            }
                            
                            // Trouver la bo√Æte du conjoint
                            const box2 = boxesArray.find(b => b.getAttribute('data-id') === spouseId);
                            
                            if (box2 && box1 !== box2) {
                                console.log(`Drawing line between ${person1.name} and spouse`);
                                
                                // Marquer cette paire comme dessin√©e
                                drawnPairs.add(pairKey1);
                                
                                // Calculer les positions
                                const rect1 = box1.getBoundingClientRect();
                                const rect2 = box2.getBoundingClientRect();
                                const containerRect = genRow.getBoundingClientRect();
                                
                                // Positions relatives au conteneur
                                const x1 = rect1.left - containerRect.left + rect1.width / 2;
                                const y1 = rect1.top - containerRect.top + rect1.height / 2;
                                const x2 = rect2.left - containerRect.left + rect2.width / 2;
                                const y2 = rect2.top - containerRect.top + rect2.height / 2;
                                
                                // Cr√©er une ligne en pointill√©s
                                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                                line.setAttribute('x1', x1);
                                line.setAttribute('y1', y1);
                                line.setAttribute('x2', x2);
                                line.setAttribute('y2', y2);
                                line.setAttribute('stroke', '#2c5f4f');
                                line.setAttribute('stroke-width', '2');
                                line.setAttribute('stroke-dasharray', '5,5');
                                line.setAttribute('opacity', '0.5');
                                
                                svg.appendChild(line);
                            } else {
                                console.log(`Spouse ${spouseId} not found in same generation`);
                            }
                        });
                    }
                });
                
                // Ajouter le SVG au d√©but du conteneur de g√©n√©ration
                if (svg.childElementCount > 0) {
                    console.log(`Adding SVG with ${svg.childElementCount} elements`);
                    genRow.insertBefore(svg, genRow.firstChild);
                } else {
                    console.log('No lines to draw in this generation');
                }
            });
        }

        function createPersonBox(p, g) {
            const c = getGenerationColor(g);
            const dates = p.dates || (p.born ? `n√© ${p.born}` : '');
            const role = p.role ? `<div class="person-role">${p.role}</div>` : '';
            
            // Classes CSS additionnelles
            let cssClasses = 'person-box';
            
            // D√©tecter si c'est une lign√©e fusionn√©e (a des parents ET un conjoint)
            let mergedLineageIndicator = '';
            if (p.parentId && p.spouseIds && p.spouseIds.length > 0) {
                const parent = familyData.persons.find(x => x.id === p.parentId);
                if (parent) {
                    const parentGen = getGeneration(p.parentId);
                    const currentGen = getGeneration(p.id);
                    if (parentGen < currentGen - 1 || parentGen === currentGen) {
                        // Cette personne apporte sa propre lign√©e
                        cssClasses += ' merged-lineage';
                        const lineageSource = p.birthPlace || (parent.birthPlace || 'autre famille');
                        mergedLineageIndicator = `<div style="font-size: 0.75em; opacity: 0.7; margin-top: 4px; font-style: italic;">‚Üñ Lign√©e ${lineageSource}</div>`;
                    }
                }
            }
            
            // Badge mariage si la personne a un/des conjoint(s)
            if (p.spouseIds && p.spouseIds.length > 0) {
                cssClasses += ' married';
            }
            
            // Trouver le(s) conjoint(s)
            let spouseInfo = '';
            // N'afficher les infos de conjoint EN BAS de la bo√Æte que si le toggle est D√âSACTIV√â
            if (!showSpousesAsSeparateBoxes && p.spouseIds && p.spouseIds.length > 0) {
                const spouses = p.spouseIds
                    .map(id => familyData.persons.find(s => s.id === id))
                    .filter(s => s); // Filtrer les undefined
                
                if (spouses.length > 0) {
                    spouseInfo = '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">';
                    spouses.forEach((spouse, idx) => {
                        const spouseName = spouse.name.split(' ').slice(-2).join(' '); // Prendre 2 derniers mots
                        
                        // Utiliser le champ gender du JSON
                        const label = spouse.gender === 'F' ? 'Conjointe' : 'Conjoint';
                        spouseInfo += `<div style="font-size: 0.85em; opacity: 0.9;"><strong>${label}:</strong> ${spouseName}</div>`;
                    });
                    spouseInfo += '</div>';
                }
            }
            
            return `
                <div class="${cssClasses}" data-id="${p.id}" data-name="${p.name.toLowerCase()}" style="background: ${c.bg}; border-color: ${c.border}; ${c.color ? `color: ${c.color};` : ''}" onclick="showPersonDetails('${p.id}')">
                    <div class="person-name">${p.name}</div>
                    ${dates ? `<div class="person-dates">${dates}</div>` : ''}
                    ${role}
                    ${mergedLineageIndicator}
                    ${spouseInfo}
                </div>
            `;
        }

        function showPersonDetails(id) {
            const p = familyData.persons.find(x => x.id === id);
            const parent = p.parentId ? familyData.persons.find(x => x.id === p.parentId) : null;
            const children = familyData.persons.filter(x => x.parentId === p.id);
            
            // V√©rifier si c'est une lign√©e fusionn√©e
            let mergedLineageHTML = '';
            if (p.parentId && p.spouseIds && p.spouseIds.length > 0) {
                const parentGen = getGeneration(p.parentId);
                const currentGen = getGeneration(p.id);
                const spouse = familyData.persons.find(s => s.id === p.spouseIds[0]);
                const spouseGen = spouse ? getGeneration(spouse.id) : null;
                
                if (parentGen && spouseGen && currentGen === spouseGen && parentGen < currentGen) {
                    mergedLineageHTML = `
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-top: 15px;">
                            <strong>üîó Fusion de deux lign√©es familiales</strong><br>
                            <em style="font-size: 0.9em;">
                                ${p.name} apporte sa propre lign√©e ancestrale (${p.birthPlace || 'origine familiale'}) 
                                et rejoint la famille par mariage avec ${spouse ? spouse.name : 'conjoint'}.
                            </em>
                        </div>
                    `;
                }
            }
            
            // Informations sur le(s) conjoint(s)
            let spousesHTML = '';
            if (p.spouseIds && p.spouseIds.length > 0) {
                const spouses = p.spouseIds
                    .map(sid => familyData.persons.find(s => s.id === sid))
                    .filter(s => s);
                
                if (spouses.length > 0) {
                    spousesHTML = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">';
                    spousesHTML += `<h3 style="color: #2c5f4f; margin-bottom: 15px;">Conjoint${spouses.length > 1 ? 's' : ''}</h3>`;
                    
                    spouses.forEach((spouse, idx) => {
                        if (idx > 0) spousesHTML += '<hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">';
                        spousesHTML += `<div>`;
                        spousesHTML += `<h4 style="color: #4a7c6b; margin-bottom: 8px;">${spouse.name}</h4>`;
                        if (spouse.ndap) spousesHTML += `<p><strong>Ndap:</strong> ${spouse.ndap}</p>`;
                        if (spouse.dates || spouse.born) spousesHTML += `<p><strong>üìÖ:</strong> ${spouse.dates || 'N√© ' + spouse.born}</p>`;
                        if (spouse.birthPlace) spousesHTML += `<p><strong>üìç Naissance:</strong> ${spouse.birthPlace}</p>`;
                        if (spouse.residence) spousesHTML += `<p><strong>üè† R√©sidence:</strong> ${spouse.residence}</p>`;
                        if (spouse.notes) spousesHTML += `<p style="margin-top: 8px;"><em>${spouse.notes}</em></p>`;
                        spousesHTML += `</div>`;
                    });
                    
                    spousesHTML += '</div>';
                }
            }
            
            document.getElementById('modalBody').innerHTML = `
                <h2 style="color: #2c5f4f;">${p.name}</h2>
                ${p.ndap ? `<p><em>Ndap: ${p.ndap}</em></p>` : ''}
                ${p.dates || p.born ? `<p><strong>üìÖ:</strong> ${p.dates || 'N√© ' + p.born}</p>` : ''}
                <p><strong>üß¨ G√©n√©ration:</strong> ${getGeneration(id)}</p>
                ${p.birthPlace ? `<p><strong>üìç Naissance:</strong> ${p.birthPlace}</p>` : ''}
                ${p.residence ? `<p><strong>üè† R√©sidence:</strong> ${p.residence}</p>` : ''}
                ${p.role ? `<p><strong>üëë R√¥le:</strong> ${p.role}</p>` : ''}
                ${parent ? `<p style="margin-top:15px;"><strong>‚¨ÜÔ∏è Parent:</strong> ${parent.name}</p>` : ''}
                ${mergedLineageHTML}
                ${spousesHTML}
                ${children.length > 0 ? `<div style="margin-top:15px;"><strong>‚¨áÔ∏è Enfants (${children.length}):</strong><ul style="margin-left:20px;">${children.map(c => `<li>${c.name}</li>`).join('')}</ul></div>` : ''}
                ${p.notes ? `<p style="margin-top:15px;"><strong>üìù:</strong> ${p.notes}</p>` : ''}
            `;
            document.getElementById('personModal').classList.add('active');
        }

        function closeModal() { document.getElementById('personModal').classList.remove('active'); }

        function switchTab(tab, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            if (el) el.classList.add('active');
        }

        function renderPersonsList() {
            const sorted = [...familyData.persons].sort((a, b) => {
                const d = getGeneration(a.id) - getGeneration(b.id);
                return d !== 0 ? d : a.name.localeCompare(b.name);
            });
            document.getElementById('personsList').innerHTML = sorted.map(p => `
                <div class="person-item" data-name="${p.name.toLowerCase()}" onclick="showPersonDetails('${p.id}')">
                    <h4>${p.name}</h4>
                    <p>G√©n√©ration ${getGeneration(p.id)}</p>
                    ${p.residence ? `<p>üìç ${p.residence}</p>` : ''}
                </div>
            `).join('');
        }

        function filterPersons() {
            const searchTerm = document.getElementById('personSearch').value.toLowerCase();
            const items = document.querySelectorAll('.person-item');
            items.forEach(item => {
                const name = item.getAttribute('data-name');
                item.style.display = name.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function renderLocations() {
            document.getElementById('locationsGrid').innerHTML = familyData.locations.map(l => `
                <div class="location-card">
                    <h3>üìç ${l.name}</h3>
                    <p style="color:#666;">${l.description}</p>
                </div>
            `).join('');
        }

        function renderTimeline() {
            const events = [
                { date: "~1770s", title: "Origines Royales", content: "Prince Nandjo, fondateur de la chefferie de Balengou. Migration de Baleng vers Bamena puis Balengou." },
                { date: "~1800s", title: "Lign√©e Royale", content: "Wetio Kouamou et Tchi√© Ngantchi√© √©tablissent les lign√©es de Balengou et Batchingou." },
                { date: "~1850s", title: "G√©n√©ration 3", content: "Magni Kouabou s'installe √† Batchingou. Mariage avec Ta'a W√©ji√©wou au lieu sacr√© Kou Tchap." },
                { date: "1898", title: "Naissance du Patriarche", content: "Ta'a Fieu Tagni Tinang Joseph na√Æt √† Batchingou (Toukou) sous le r√®gne du roi Tchiengu√©." },
                { date: "1906", title: "Mariage principal", content: "Union avec Megni Ngongang Rebecca de Bamena, petite-fille du chef Bamena." },
                { date: "1947-1968", title: "G√©n√©ration 6", content: "Naissance des 9 enfants du patriarche √† travers trois √©pouses." },
                { date: "1960", title: "Ind√©pendance", content: "Ind√©pendance du Cameroun. Installation principale √† Foumbot, quartier Company." },
                { date: "1983-2002", title: "G√©n√©ration 7", content: "Naissance de 18 petits-enfants, dispers√©s entre le Cameroun et le Canada." },
                { date: "2001", title: "Succession", content: "D√©c√®s du patriarche √† 103 ans. Poueme Emmanuel intronis√© comme Ta'a Fieu Tinang Joseph." }
            ];
            document.getElementById('timelineContent').innerHTML = events.map(e => `
                <div class="timeline-item">
                    <div class="timeline-date">${e.date}</div>
                    <div class="timeline-content">
                        <h4>${e.title}</h4>
                        <p>${e.content}</p>
                    </div>
                </div>
            `).join('');
        }

        document.addEventListener('DOMContentLoaded', loadData);
        document.getElementById('personModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
    </script>
</body>
</html>
